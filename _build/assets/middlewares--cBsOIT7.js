import{j as i}from"./jsx-runtime-OjB1YB6s.js";import{u as r}from"./index-Crl2ozBJ.js";const o={commitTime:1728386521},h=[{id:"服务中间件",text:"服务中间件",depth:1},{id:"执行顺序",text:"执行顺序",depth:2},{id:"提前响应",text:"提前响应",depth:2}];function n(e){const s={code:"code",h1:"h1",h2:"h2",p:"p",pre:"pre",span:"span",...r(),...e.components},{Callout:l}=s;return l||a("Callout"),i.jsxs(i.Fragment,{children:[i.jsx(s.h1,{id:"服务中间件",children:"服务中间件"}),`
`,i.jsxs(s.p,{children:["Servite 默认会把 ",i.jsx(s.code,{children:"src/server/middlewares/"})," 下的文件当做中间件。可以通过 ",i.jsx(s.code,{children:"defineMiddleware"})," 来定义中间件："]}),`
`,i.jsx(s.pre,{className:"shiki shiki-themes min-light plastic",style:{backgroundColor:"#ffffff","--shiki-dark-bg":"#21252B",color:"#24292eff","--shiki-dark":"#A9B2C3"},tabIndex:"0",children:i.jsxs(s.code,{children:[i.jsxs(s.span,{className:"line",children:[i.jsx(s.span,{style:{color:"#D32F2F","--shiki-dark":"#E06C75"},children:"import"}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:" { "}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#C6CCD7"},children:"defineMiddleware"}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:" } "}),i.jsx(s.span,{style:{color:"#D32F2F","--shiki-dark":"#E06C75"},children:"from"}),i.jsx(s.span,{style:{color:"#22863A","--shiki-dark":"#A9B2C3"},children:" '"}),i.jsx(s.span,{style:{color:"#22863A","--shiki-dark":"#98C379"},children:"servite/runtime/server"}),i.jsx(s.span,{style:{color:"#22863A","--shiki-dark":"#A9B2C3"},children:"'"}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:";"})]}),`
`,i.jsx(s.span,{className:"line"}),`
`,i.jsxs(s.span,{className:"line",children:[i.jsx(s.span,{style:{color:"#D32F2F","--shiki-dark":"#E06C75"},children:"export"}),i.jsx(s.span,{style:{color:"#D32F2F","--shiki-dark":"#E06C75"},children:" default"}),i.jsx(s.span,{style:{color:"#6F42C1","--shiki-dark":"#B57EDC"},children:" defineMiddleware"}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:"("}),i.jsx(s.span,{style:{color:"#D32F2F","--shiki-dark":"#61AFEF"},children:"async"}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:" ("}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#C6CCD7"},children:"event"}),i.jsx(s.span,{style:{color:"#212121","--shiki-dark":"#A9B2C3"},children:","}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#C6CCD7"},children:" next"}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:") "}),i.jsx(s.span,{style:{color:"#D32F2F","--shiki-dark":"#61AFEF"},children:"=>"}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:" {"})]}),`
`,i.jsx(s.span,{className:"line",children:i.jsx(s.span,{style:{color:"#C2C3C5","--shiki-dark":"#5F6672",fontStyle:"inherit","--shiki-dark-font-style":"italic"},children:"   // ... do something on request"})}),`
`,i.jsxs(s.span,{className:"line",children:[i.jsx(s.span,{style:{color:"#D32F2F","--shiki-dark":"#E06C75"},children:"   await"}),i.jsx(s.span,{style:{color:"#6F42C1","--shiki-dark":"#B57EDC"},children:" next"}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:"(); "}),i.jsx(s.span,{style:{color:"#C2C3C5","--shiki-dark":"#5F6672",fontStyle:"inherit","--shiki-dark-font-style":"italic"},children:"// call next middleware"})]}),`
`,i.jsx(s.span,{className:"line",children:i.jsx(s.span,{style:{color:"#C2C3C5","--shiki-dark":"#5F6672",fontStyle:"inherit","--shiki-dark-font-style":"italic"},children:"   // ... do something before response"})}),`
`,i.jsx(s.span,{className:"line",children:i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:"});"})})]})}),`
`,i.jsx(s.h2,{id:"执行顺序",children:"执行顺序"}),`
`,i.jsx(s.p,{children:`中间件的执行顺序是由文件的顺序决定的，并且有点类似于 Koa 的洋葱模型：
一个请求到达服务器时，会首先从外向内经过每一层中间件，到达核心处理器后，再由内向外依次经过相同的中间件。`}),`
`,i.jsx(s.p,{children:"例如，文件目录结构如下所示："}),`
`,i.jsx(s.pre,{className:"shiki shiki-themes min-light plastic",style:{backgroundColor:"#ffffff","--shiki-dark-bg":"#21252B",color:"#24292eff","--shiki-dark":"#A9B2C3"},tabIndex:"0",children:i.jsxs(s.code,{children:[i.jsxs(s.span,{className:"line",children:[i.jsx(s.span,{style:{color:"#D32F2F","--shiki-dark":"#E06C75"},children:"<"}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:"root"}),i.jsx(s.span,{style:{color:"#D32F2F","--shiki-dark":"#E06C75"},children:">"})]}),`
`,i.jsxs(s.span,{className:"line",children:[i.jsx(s.span,{style:{color:"#6F42C1","--shiki-dark":"#B57EDC"},children:"└─"}),i.jsx(s.span,{style:{color:"#2B5581","--shiki-dark":"#98C379"},children:" src"}),i.jsx(s.span,{style:{color:"#C2C3C5","--shiki-dark":"#5F6672",fontStyle:"inherit","--shiki-dark-font-style":"italic"},children:"                # 源码目录"})]}),`
`,i.jsxs(s.span,{className:"line",children:[i.jsx(s.span,{style:{color:"#6F42C1","--shiki-dark":"#B57EDC"},children:"   └─"}),i.jsx(s.span,{style:{color:"#2B5581","--shiki-dark":"#98C379"},children:" server"}),i.jsx(s.span,{style:{color:"#C2C3C5","--shiki-dark":"#5F6672",fontStyle:"inherit","--shiki-dark-font-style":"italic"},children:"          # 服务端源码目录"})]}),`
`,i.jsxs(s.span,{className:"line",children:[i.jsx(s.span,{style:{color:"#6F42C1","--shiki-dark":"#B57EDC"},children:"      └─"}),i.jsx(s.span,{style:{color:"#2B5581","--shiki-dark":"#98C379"},children:" middlewares"}),i.jsx(s.span,{style:{color:"#C2C3C5","--shiki-dark":"#5F6672",fontStyle:"inherit","--shiki-dark-font-style":"italic"},children:"  # 中间件目录"})]}),`
`,i.jsxs(s.span,{className:"line",children:[i.jsx(s.span,{style:{color:"#6F42C1","--shiki-dark":"#B57EDC"},children:"         ├─"}),i.jsx(s.span,{style:{color:"#2B5581","--shiki-dark":"#98C379"},children:" a.ts"})]}),`
`,i.jsxs(s.span,{className:"line",children:[i.jsx(s.span,{style:{color:"#6F42C1","--shiki-dark":"#B57EDC"},children:"         ├─"}),i.jsx(s.span,{style:{color:"#2B5581","--shiki-dark":"#98C379"},children:" b.ts"})]}),`
`,i.jsxs(s.span,{className:"line",children:[i.jsx(s.span,{style:{color:"#6F42C1","--shiki-dark":"#B57EDC"},children:"         └─"}),i.jsx(s.span,{style:{color:"#2B5581","--shiki-dark":"#98C379"},children:" c.ts"})]})]})}),`
`,i.jsx(s.p,{children:"那与之对应的中间件执行顺序是："}),`
`,i.jsx(s.pre,{className:"shiki shiki-themes min-light plastic",style:{backgroundColor:"#ffffff","--shiki-dark-bg":"#21252B",color:"#24292eff","--shiki-dark":"#A9B2C3"},tabIndex:"0",children:i.jsxs(s.code,{children:[i.jsx(s.span,{className:"line",children:i.jsx(s.span,{children:"Request → a → b → c → Response"})}),`
`,i.jsx(s.span,{className:"line",children:i.jsx(s.span,{children:"          a ← b ← c ↩︎"})})]})}),`
`,i.jsxs(s.p,{children:["为了使得中间件的执行顺序更为可控，推荐给文件名添加数字前缀，例如：",i.jsx(s.code,{children:"0.name.ts"}),"，",i.jsx(s.code,{children:"1.name.ts"}),` 等。
但如果你有超过 10 个中间件，那么可以使用两位数字前缀，例如：`,i.jsx(s.code,{children:"00.name.ts"}),"，",i.jsx(s.code,{children:"01.name.ts"}),`，
这样能容纳 100 个中间件，已经完全足够了。`]}),`
`,i.jsx(s.h2,{id:"提前响应",children:"提前响应"}),`
`,i.jsxs(s.p,{children:["如果想在中间件中提前响应请求，那么应该使用 ",i.jsx(s.code,{children:"send()"}),"、",i.jsx(s.code,{children:"event.node.res.end()"})," 等方法来提前发送响应，这时候也可以去掉 ",i.jsx(s.code,{children:"await next()"})," 的调用了。"]}),`
`,i.jsx(s.pre,{className:"shiki shiki-themes min-light plastic",style:{backgroundColor:"#ffffff","--shiki-dark-bg":"#21252B",color:"#24292eff","--shiki-dark":"#A9B2C3"},tabIndex:"0",children:i.jsxs(s.code,{children:[i.jsxs(s.span,{className:"line",children:[i.jsx(s.span,{style:{color:"#D32F2F","--shiki-dark":"#E06C75"},children:"import"}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:" { "}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#C6CCD7"},children:"defineMiddleware"}),i.jsx(s.span,{style:{color:"#212121","--shiki-dark":"#A9B2C3"},children:","}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#C6CCD7"},children:" send"}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:" } "}),i.jsx(s.span,{style:{color:"#D32F2F","--shiki-dark":"#E06C75"},children:"from"}),i.jsx(s.span,{style:{color:"#22863A","--shiki-dark":"#A9B2C3"},children:" '"}),i.jsx(s.span,{style:{color:"#22863A","--shiki-dark":"#98C379"},children:"servite/runtime/server"}),i.jsx(s.span,{style:{color:"#22863A","--shiki-dark":"#A9B2C3"},children:"'"}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:";"})]}),`
`,i.jsx(s.span,{className:"line"}),`
`,i.jsxs(s.span,{className:"line",children:[i.jsx(s.span,{style:{color:"#D32F2F","--shiki-dark":"#E06C75"},children:"export"}),i.jsx(s.span,{style:{color:"#D32F2F","--shiki-dark":"#E06C75"},children:" default"}),i.jsx(s.span,{style:{color:"#6F42C1","--shiki-dark":"#B57EDC"},children:" defineMiddleware"}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:"("}),i.jsx(s.span,{style:{color:"#D32F2F","--shiki-dark":"#61AFEF"},children:"async"}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:" ("}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#C6CCD7"},children:"event"}),i.jsx(s.span,{style:{color:"#212121","--shiki-dark":"#A9B2C3"},children:","}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#C6CCD7"},children:" _next"}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:") "}),i.jsx(s.span,{style:{color:"#D32F2F","--shiki-dark":"#61AFEF"},children:"=>"}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:" {"})]}),`
`,i.jsx(s.span,{className:"line",children:i.jsx(s.span,{style:{color:"#C2C3C5","--shiki-dark":"#5F6672",fontStyle:"inherit","--shiki-dark-font-style":"italic"},children:"   // 提前在中间件里发送响应"})}),`
`,i.jsxs(s.span,{className:"line",children:[i.jsx(s.span,{style:{color:"#D32F2F","--shiki-dark":"#E06C75"},children:"   await"}),i.jsx(s.span,{style:{color:"#6F42C1","--shiki-dark":"#B57EDC"},children:" send"}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:"("}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#C6CCD7"},children:"event"}),i.jsx(s.span,{style:{color:"#212121","--shiki-dark":"#A9B2C3"},children:","}),i.jsx(s.span,{style:{color:"#22863A","--shiki-dark":"#A9B2C3"},children:" '"}),i.jsx(s.span,{style:{color:"#22863A","--shiki-dark":"#98C379"},children:"some data"}),i.jsx(s.span,{style:{color:"#22863A","--shiki-dark":"#A9B2C3"},children:"'"}),i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:");"})]}),`
`,i.jsx(s.span,{className:"line",children:i.jsx(s.span,{style:{color:"#24292EFF","--shiki-dark":"#A9B2C3"},children:"});"})})]})}),`
`,i.jsx(l,{type:"warning",children:i.jsxs(s.p,{children:["在中间件中，如果没有调用 ",i.jsx(s.code,{children:"await next()"})," 来执行下一个中间件，并且请求还没有被响应，那么请求将会一直处于 pending 的状态，这通常是代码逻辑错误导致的。"]})})]})}function t(e={}){const{wrapper:s}={...r(),...e.components};return s?i.jsx(s,{...e,children:i.jsx(n,{...e})}):n(e)}function a(e,s){throw new Error("Expected component `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}export{t as default,o as frontmatter,h as toc};
